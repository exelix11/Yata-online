function JpegDecode(e,r){var n=new Uint8Array(e),a=new JpegImage;a.parse(n);var o={width:a.width,height:a.height,data:r?new Uint8Array(a.width*a.height*4):new Buffer(a.width*a.height*4)};return a.copyToImageData(o),o}var JpegImage=function(){"use strict";function e(){}function r(e,r){for(var n,a,o=0,s=[],t=16;t>0&&!e[t-1];)t--;s.push({children:[],index:0});var i,c=s[0];for(n=0;n<t;n++){for(a=0;a<e[n];a++){for((c=s.pop()).children[c.index]=r[o];c.index>0;)c=s.pop();for(c.index++,s.push(c);s.length<=n;)s.push(i={children:[],index:0}),c.children[c.index]=i.children,c=i;o++}n+1<t&&(s.push(i={children:[],index:0}),c.children[c.index]=i.children,c=i)}return s[0].children}function n(e,r,n,a,o,t,i,c,f){function l(){if(A>0)return A--,X>>A&1;if(255==(X=e[r++])){var n=e[r++];if(n)throw new Error("unexpected marker: "+(X<<8|n).toString(16))}return A=7,X>>>7}function h(e){for(var r,n=e;null!==(r=l());){if("number"==typeof(n=n[r]))return n;if("object"!=typeof n)throw new Error("invalid huffman sequence")}return null}function u(e){for(var r=0;e>0;){var n=l();if(null===n)return;r=r<<1|n,e--}return r}function p(e){var r=u(e);return r>=1<<e-1?r:r+(-1<<e)+1}n.precision,n.samplesPerLine,n.scanLines;var m,v,d,b,w,k,g,y=n.mcusPerLine,P=n.progressive,x=(n.maxH,n.maxV,r),X=0,A=0,L=0,T=0,C=a.length;g=P?0===t?0===c?function(e,r){var n=h(e.huffmanTableDC),a=0===n?0:p(n)<<f;r[0]=e.pred+=a}:function(e,r){r[0]|=l()<<f}:0===c?function(e,r){if(L>0)L--;else for(var n=t,a=i;n<=a;){var o=h(e.huffmanTableAC),c=15&o,l=o>>4;if(0!==c)r[s[n+=l]]=p(c)*(1<<f),n++;else{if(l<15){L=u(l)+(1<<l)-1;break}n+=16}}}:function(e,r){for(var n=t,a=i,o=0;n<=a;){var c=s[n],v=r[c]<0?-1:1;switch(T){case 0:var d=h(e.huffmanTableAC),b=15&d,o=d>>4;if(0===b)o<15?(L=u(o)+(1<<o),T=4):(o=16,T=1);else{if(1!==b)throw new Error("invalid ACn encoding");m=p(b),T=o?2:3}continue;case 1:case 2:r[c]?r[c]+=(l()<<f)*v:0==--o&&(T=2==T?3:0);break;case 3:r[c]?r[c]+=(l()<<f)*v:(r[c]=m<<f,T=0);break;case 4:r[c]&&(r[c]+=(l()<<f)*v)}n++}4===T&&0==--L&&(T=0)}:function(e,r){var n=h(e.huffmanTableDC),a=0===n?0:p(n);r[0]=e.pred+=a;for(var o=1;o<64;){var t=h(e.huffmanTableAC),i=15&t,c=t>>4;if(0!==i)r[s[o+=c]]=p(i),o++;else{if(c<15)break;o+=16}}};var D,I,U=0;I=1==C?a[0].blocksPerLine*a[0].blocksPerColumn:y*n.mcusPerColumn,o||(o=I);for(var E,Y;U<I;){for(d=0;d<C;d++)a[d].pred=0;if(L=0,1==C)for(v=a[0],k=0;k<o;k++)!function(e,r,n){var a=n/e.blocksPerLine|0,o=n%e.blocksPerLine;r(e,e.blocks[a][o])}(v,g,U),U++;else for(k=0;k<o;k++){for(d=0;d<C;d++)for(E=(v=a[d]).h,Y=v.v,b=0;b<Y;b++)for(w=0;w<E;w++)!function(e,r,n,a,o){var s=n%y,t=(n/y|0)*e.v+a,i=s*e.h+o;r(e,e.blocks[t][i])}(v,g,U,b,w);if(++U===I)break}if(A=0,(D=e[r]<<8|e[r+1])<65280)throw new Error("marker was not found");if(!(D>=65488&&D<=65495))break;r+=2}return r-x}function a(e,r){for(var n,a,o=[],s=r.blocksPerLine,m=r.blocksPerColumn,v=s<<3,d=new Int32Array(64),b=new Uint8Array(64),w=0;w<m;w++){var k=w<<3;for(n=0;n<8;n++)o.push(new Uint8Array(v));for(var g=0;g<s;g++){!function(e,n,a){var o,s,m,v,d,b,w,k,g,y,P=r.quantizationTable,x=a;for(y=0;y<64;y++)x[y]=e[y]*P[y];for(y=0;y<8;++y){var X=8*y;0!=x[1+X]||0!=x[2+X]||0!=x[3+X]||0!=x[4+X]||0!=x[5+X]||0!=x[6+X]||0!=x[7+X]?(o=u*x[0+X]+128>>8,s=u*x[4+X]+128>>8,m=x[2+X],v=x[6+X],d=p*(x[1+X]-x[7+X])+128>>8,k=p*(x[1+X]+x[7+X])+128>>8,b=x[3+X]<<4,w=x[5+X]<<4,g=o-s+1>>1,o=o+s+1>>1,s=g,g=m*h+v*l+128>>8,m=m*l-v*h+128>>8,v=g,g=d-w+1>>1,d=d+w+1>>1,w=g,g=k+b+1>>1,b=k-b+1>>1,k=g,g=o-v+1>>1,o=o+v+1>>1,v=g,g=s-m+1>>1,s=s+m+1>>1,m=g,g=d*f+k*c+2048>>12,d=d*c-k*f+2048>>12,k=g,g=b*i+w*t+2048>>12,b=b*t-w*i+2048>>12,w=g,x[0+X]=o+k,x[7+X]=o-k,x[1+X]=s+w,x[6+X]=s-w,x[2+X]=m+b,x[5+X]=m-b,x[3+X]=v+d,x[4+X]=v-d):(g=u*x[0+X]+512>>10,x[0+X]=g,x[1+X]=g,x[2+X]=g,x[3+X]=g,x[4+X]=g,x[5+X]=g,x[6+X]=g,x[7+X]=g)}for(y=0;y<8;++y){var A=y;0!=x[8+A]||0!=x[16+A]||0!=x[24+A]||0!=x[32+A]||0!=x[40+A]||0!=x[48+A]||0!=x[56+A]?(o=u*x[0+A]+2048>>12,s=u*x[32+A]+2048>>12,m=x[16+A],v=x[48+A],d=p*(x[8+A]-x[56+A])+2048>>12,k=p*(x[8+A]+x[56+A])+2048>>12,b=x[24+A],w=x[40+A],g=o-s+1>>1,o=o+s+1>>1,s=g,g=m*h+v*l+2048>>12,m=m*l-v*h+2048>>12,v=g,g=d-w+1>>1,d=d+w+1>>1,w=g,g=k+b+1>>1,b=k-b+1>>1,k=g,g=o-v+1>>1,o=o+v+1>>1,v=g,g=s-m+1>>1,s=s+m+1>>1,m=g,g=d*f+k*c+2048>>12,d=d*c-k*f+2048>>12,k=g,g=b*i+w*t+2048>>12,b=b*t-w*i+2048>>12,w=g,x[0+A]=o+k,x[56+A]=o-k,x[8+A]=s+w,x[48+A]=s-w,x[16+A]=m+b,x[40+A]=m-b,x[24+A]=v+d,x[32+A]=v-d):(g=u*a[y+0]+8192>>14,x[0+A]=g,x[8+A]=g,x[16+A]=g,x[24+A]=g,x[32+A]=g,x[40+A]=g,x[48+A]=g,x[56+A]=g)}for(y=0;y<64;++y){var L=128+(x[y]+8>>4);n[y]=L<0?0:L>255?255:L}}(r.blocks[w][g],b,d);var y=0,P=g<<3;for(a=0;a<8;a++){var x=o[k+a];for(n=0;n<8;n++)x[P+n]=b[y++]}}}return o}function o(e){return e<0?0:e>255?255:e}var s=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),t=4017,i=799,c=3406,f=2276,l=1567,h=3784,u=5793,p=2896;return e.prototype={load:function(e){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){var e=new Uint8Array(r.response||r.mozResponseArrayBuffer);this.parse(e),this.onload&&this.onload()}.bind(this),r.send(null)},parse:function(e){function o(){var r=e[c]<<8|e[c+1];return c+=2,r}var t,i,c=0,f=(e.length,null),l=null,h=[],u=[],p=[],m=[],v=o();if(65496!=v)throw new Error("SOI not found");for(v=o();65497!=v;){switch(v){case 65280:break;case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var d=function(){var r=o(),n=e.subarray(c,c+r-2);return c+=n.length,n}();65504===v&&74===d[0]&&70===d[1]&&73===d[2]&&70===d[3]&&0===d[4]&&(f={version:{major:d[5],minor:d[6]},densityUnits:d[7],xDensity:d[8]<<8|d[9],yDensity:d[10]<<8|d[11],thumbWidth:d[12],thumbHeight:d[13],thumbData:d.subarray(14,14+3*d[12]*d[13])}),65518===v&&65===d[0]&&100===d[1]&&111===d[2]&&98===d[3]&&101===d[4]&&0===d[5]&&(l={version:d[6],flags0:d[7]<<8|d[8],flags1:d[9]<<8|d[10],transformCode:d[11]});break;case 65499:for(var b=o()+c-2;c<b;){var w=e[c++],k=new Int32Array(64);if(w>>4==0)for(J=0;J<64;J++)k[g=s[J]]=e[c++];else{if(w>>4!=1)throw new Error("DQT: invalid table spec");for(J=0;J<64;J++){var g=s[J];k[g]=o()}}h[15&w]=k}break;case 65472:case 65473:case 65474:o(),(t={}).extended=65473===v,t.progressive=65474===v,t.precision=e[c++],t.scanLines=o(),t.samplesPerLine=o(),t.components={},t.componentsOrder=[];var y,P=e[c++];for(j=0;j<P;j++){y=e[c];var x=e[c+1]>>4,X=15&e[c+1],A=e[c+2];t.componentsOrder.push(y),t.components[y]={h:x,v:X,quantizationIdx:A},c+=3}!function(e){var r,n,a=0,o=0;for(n in e.components)e.components.hasOwnProperty(n)&&(a<(r=e.components[n]).h&&(a=r.h),o<r.v&&(o=r.v));var s=Math.ceil(e.samplesPerLine/8/a),t=Math.ceil(e.scanLines/8/o);for(n in e.components)if(e.components.hasOwnProperty(n)){r=e.components[n];for(var i=Math.ceil(Math.ceil(e.samplesPerLine/8)*r.h/a),c=Math.ceil(Math.ceil(e.scanLines/8)*r.v/o),f=s*r.h,l=t*r.v,h=[],u=0;u<l;u++){for(var p=[],m=0;m<f;m++)p.push(new Int32Array(64));h.push(p)}r.blocksPerLine=i,r.blocksPerColumn=c,r.blocks=h}e.maxH=a,e.maxV=o,e.mcusPerLine=s,e.mcusPerColumn=t}(t),u.push(t);break;case 65476:var L=o();for(j=2;j<L;){var T=e[c++],C=new Uint8Array(16),D=0;for(J=0;J<16;J++,c++)D+=C[J]=e[c];var I=new Uint8Array(D);for(J=0;J<D;J++,c++)I[J]=e[c];j+=17+D,(T>>4==0?m:p)[15&T]=r(C,I)}break;case 65501:o(),i=o();break;case 65498:o();var U=e[c++],E=[];for(j=0;j<U;j++){G=t.components[e[c++]];var Y=e[c++];G.huffmanTableDC=m[Y>>4],G.huffmanTableAC=p[15&Y],E.push(G)}var q=e[c++],M=e[c++],O=e[c++],z=n(e,c,t,E,i,q,M,O>>4,15&O);c+=z;break;case 65535:255!==e[c]&&c--;break;default:if(255==e[c-3]&&e[c-2]>=192&&e[c-2]<=254){c-=3;break}throw new Error("unknown JPEG marker "+v.toString(16))}v=o()}if(1!=u.length)throw new Error("only single frame JPEGs supported");for(j=0;j<u.length;j++){var H=u[j].components;for(var J in H)H[J].quantizationTable=h[H[J].quantizationIdx],delete H[J].quantizationIdx}this.width=t.samplesPerLine,this.height=t.scanLines,this.jfif=f,this.adobe=l,this.components=[];for(var j=0;j<t.componentsOrder.length;j++){var G=t.components[t.componentsOrder[j]];this.components.push({lines:a(t,G),scaleX:G.h/t.maxH,scaleY:G.v/t.maxV})}},getData:function(e,r){var n,a,s,t,i,c,f,l,h,u,p,m,v,d,b,w,k,g,y,P,x,X=this.width/e,A=this.height/r,L=0,T=e*r*this.components.length,C=new Uint8Array(T);switch(this.components.length){case 1:for(n=this.components[0],u=0;u<r;u++)for(i=n.lines[0|u*n.scaleY*A],h=0;h<e;h++)p=i[0|h*n.scaleX*X],C[L++]=p;break;case 2:for(n=this.components[0],a=this.components[1],u=0;u<r;u++)for(i=n.lines[0|u*n.scaleY*A],c=a.lines[0|u*a.scaleY*A],h=0;h<e;h++)p=i[0|h*n.scaleX*X],C[L++]=p,p=c[0|h*a.scaleX*X],C[L++]=p;break;case 3:for(x=!0,this.adobe&&this.adobe.transformCode?x=!0:void 0!==this.colorTransform&&(x=!!this.colorTransform),n=this.components[0],a=this.components[1],s=this.components[2],u=0;u<r;u++)for(i=n.lines[0|u*n.scaleY*A],c=a.lines[0|u*a.scaleY*A],f=s.lines[0|u*s.scaleY*A],h=0;h<e;h++)x?(p=i[0|h*n.scaleX*X],m=c[0|h*a.scaleX*X],g=o(p+1.402*((v=f[0|h*s.scaleX*X])-128)),y=o(p-.3441363*(m-128)-.71413636*(v-128)),P=o(p+1.772*(m-128))):(g=i[0|h*n.scaleX*X],y=c[0|h*a.scaleX*X],P=f[0|h*s.scaleX*X]),C[L++]=g,C[L++]=y,C[L++]=P;break;case 4:if(!this.adobe)throw"Unsupported color mode (4 components)";for(x=!1,this.adobe&&this.adobe.transformCode?x=!0:void 0!==this.colorTransform&&(x=!!this.colorTransform),n=this.components[0],a=this.components[1],s=this.components[2],t=this.components[3],u=0;u<r;u++)for(i=n.lines[0|u*n.scaleY*A],c=a.lines[0|u*a.scaleY*A],f=s.lines[0|u*s.scaleY*A],l=t.lines[0|u*t.scaleY*A],h=0;h<e;h++)x?(p=i[0|h*n.scaleX*X],m=c[0|h*a.scaleX*X],v=f[0|h*s.scaleX*X],d=l[0|h*t.scaleX*X],b=255-o(p+1.402*(v-128)),w=255-o(p-.3441363*(m-128)-.71413636*(v-128)),k=255-o(p+1.772*(m-128))):(b=i[0|h*n.scaleX*X],w=c[0|h*a.scaleX*X],k=f[0|h*s.scaleX*X],d=l[0|h*t.scaleX*X]),C[L++]=255-b,C[L++]=255-w,C[L++]=255-k,C[L++]=255-d;break;default:throw"Unsupported color mode"}return C},copyToImageData:function(e){var r,n,a,s,t,i,c,f,l,h=e.width,u=e.height,p=e.data,m=this.getData(h,u),v=0,d=0;switch(this.components.length){case 1:for(n=0;n<u;n++)for(r=0;r<h;r++)a=m[v++],p[d++]=a,p[d++]=a,p[d++]=a,p[d++]=255;break;case 3:for(n=0;n<u;n++)for(r=0;r<h;r++)c=m[v++],f=m[v++],l=m[v++],p[d++]=c,p[d++]=f,p[d++]=l,p[d++]=255;break;case 4:for(n=0;n<u;n++)for(r=0;r<h;r++)t=m[v++],i=m[v++],a=m[v++],c=255-o(t*(1-(s=m[v++])/255)+s),f=255-o(i*(1-s/255)+s),l=255-o(a*(1-s/255)+s),p[d++]=c,p[d++]=f,p[d++]=l,p[d++]=255;break;default:throw"Unsupported color mode"}}},e}();